# 算法思想

## 目录
1. [研究背景与问题](#研究背景与问题)
2. [核心创新点](#核心创新点)
3. [算法设计思路](#算法设计思路)
4. [工作流程](#工作流程)
5. [关键假设](#关键假设)

---

## 研究背景与问题

### 问题一：遥感观测的地表温度(LST)不能完全反映城市热环境

城市热环境由许多部分组成，可以通过地表温度、近地面(2m)温度和体感温度等指标进行确定。然而由于地面气象站观测点少，无法提供足够高空间分辨率的气象数据刻画高度异质性的城市热环境。

虽然LST是遥感最容易获取的温度指标，但是不能完全反映热舒适水平。本研究要回答的第一个问题是：**能否使用遥感数据同化陆面模式计算近地面温度？**

### 问题二：城市地表景观描述存在"语义鸿沟"

Oke和Stewart在2012年提出的Local Climate Zone(LCZ)成为遥感学者们开展精细化的城市研究进行地表建模的重要范式。但在遥感应用中长期存在两个问题：

1. LCZ需要高精度的三维建筑数据
2. LCZ只是一个概念模型，需要构建算法对城市地表进行合理分类

目前多数采用LCZ研究的文献采用的是LCZ generator的工作流，即综合雷达数据、土地利用数据和光学遥感数据等多源数据，勾选样本进行栅格级的预测。但这样的分类没有明确的LCZ边界。**LCZ并不是一个小尺度的概念，相反他是一个街区尺度的概念**，Oke甚至指出一个LCZ的直径不应该小于2km(否则无法构成微气候区)。进行像元级的类型预测与实际的LCZ内涵之间存在"语义鸿沟"，这是本研究要解决的第二个问题。

### 问题三：遥感应用中使用的地表同化模型多数忽略了城市地表特殊性

虽然大气学家发展了多种城市模型耦合CFD开展了精细化的城市热环境模拟，但是在遥感应用方面，使用的模型多数模型考虑的如SEBAL主要为自然地表类型设计，缺乏捕捉城市特征的能力(如未充分考虑城市形态、建筑影响等)。

在调研了很多文献后，发现想要量化城市中的各种通量项如人类活动、潜热蒸散发、建筑荫蔽等是非常困难的。这是本研究要解决的第三个问题：**在定量模型的基础上引入经验项，使用统计的方法进行定量讨论**。

值得注意的是，问题三所构建的半物理模型是建立在对问题二的回答的基础上。因为本研究构建了一种算法构建了街区尺度的边界明确的LCZ，每一个LCZ区可以列一个辐射能量平衡方程，从而提供了统计的数学基础。

---

## 核心创新点

### 1. 基于多源数据集和图机器学习算法的LCZ分类算法

**方法**：
- 使用最新的中国三维建筑数据集基于维诺图构建建筑的邻接矩阵
- 图注意力网络(Graph Attention Networks, GAT)进行建筑级别的LCZ标签预测
- 谱聚类(spectral clustering)进行LCZ边界划分
- 根据类中预测的主体标签进行LCZ确定

**优势**：
- 解决了像元级分类与街区级LCZ概念的语义鸿沟
- 提供了明确的LCZ边界
- 考虑了建筑之间的空间关系

### 2. 基于遥感地表温度数据和地表能量平衡方程的近地面气温计算模型

**方法**：
- 借助前文构建的高精度LCZ模型进一步完善城市能量平衡方程
- 引入线性隐变量使用两步最小二乘法ALS迭代估算近地表地气温差从而计算近地表温度

**特点**：
- 近地表气温Ta是待估计参数，不使用ERA5-Land的气温数据
- 通过能量平衡方程约束，使所有像元的能量平衡达到最优闭合
- 区分可量化通量和待估计通量

### 3. 基于统计方法的城市生态空间降温效益量化方法

**方法**：
- 构建因子在近地表温度的潜在影响因素中考虑相邻LCZ的影响
- 量化相邻街区温度对该区温度的影响强度(方差解释性)

**应用**：
- 为城市热适应规划和政策提供参考
- 量化生态空间的降温效益

---

## 算法设计思路

### 整体架构

模型采用**三阶段架构**：

```
阶段1: 栅格级物理计算
  ↓
阶段2: 空间聚合（栅格 → 街区）
  ↓
阶段3: 街区级回归求解
```

### 阶段1：栅格级物理计算

**核心思想**：在栅格层面**不需要知道Ta的具体值**，只计算Ta的系数和常数项。

**计算内容**：
- 空气动力学参数（阻抗、水汽压、风速等）
- 能量平衡系数（∂f/∂Ta, residual）

**输出**：
- `f_Ta_coeff`: Ta的系数 (W/m²/K)
- `residual`: 不依赖Ta的残差 (W/m²)

**物理含义**：
```
能量平衡方程：Q* - ΔQSg - QH - QE = 0

分解为：
  f(Ta) = coeff_Ta × Ta + residual = 0

其中：
  coeff_Ta = ∂Q*/∂Ta - ∂QH/∂Ta
           = ε₀·4εₐσTa₀³ - (ρCp/rah)

  residual = Q*|const - ΔQSg - QH|const - QE
```

### 阶段2：空间聚合

**核心思想**：将栅格系数聚合到每个街区（求平均）。

**方法**：
- 使用街区多边形对栅格进行空间聚合
- 对每个街区内的栅格系数求平均值
- 每个街区得到一个标量系数

**输出**：
- 每个街区的平均系数（n个街区 × 3个变量）

### 阶段3：街区级回归求解

**核心思想**：每个街区只有一个气温Ta，通过系数分解和街区级回归求解。

**方法**：
- 使用交替最小二乘法（ALS）求解每个街区的Ta
- 同时估计线性系数（QF, ΔQSb, ΔQA的影响因子）

**回归方程**：
```
对第k个街区：
f^k(Ta_k) + Σαi·X^k_Fi + Σβi·X^k_Si = 0

展开：
[f_Ta_coeff_k] × Ta_k + [residual_k] + Σαi·X^k_Fi + Σβi·X^k_Si = 0
```

**ALS迭代过程**：
1. 固定Ta，拟合线性系数 α, β
2. 固定α, β，优化每个街区的Ta
3. 重复直到收敛

---

## 工作流程

### 完整工作流

```
输入数据
  ├─ ERA5-Land (气象数据)
  ├─ Landsat (遥感数据)
  ├─ DEM (数字高程模型)
  ├─ LCZ (局部气候区分类)
  └─ Districts (街区矢量)
        ↓
[阶段1: 物理计算]
  ├─ 数据加载与对齐
  ├─ 空气动力学参数计算
  │   ├─ 空气密度 ρ(Ta)
  │   ├─ 水汽压 (从露点温度)
  │   ├─ 风速 (从ERA5分量)
  │   └─ 阻抗参数 (rah, rs)
  └─ 能量平衡系数计算
      ├─ 净辐射 Q*(Ta)
      ├─ 土壤热通量 ΔQSg(Ta)
      ├─ 感热通量 QH(Ta)
      ├─ 潜热通量 QE(Ta)
      └─ 系数分解 (∂f/∂Ta, residual)
        ↓
[阶段2: 空间聚合]
  └─ 栅格系数聚合到街区
      ├─ f_Ta_coeff_mean
      ├─ residual_mean
      └─ era5_air_temperature_mean (参考值)
        ↓
[阶段3: 街区回归]
  ├─ 准备回归特征
  │   ├─ X_F (人为热特征)
  │   ├─ X_S (储热特征)
  │   └─ X_A (水平交换特征)
  ├─ ALS回归求解
  │   ├─ 估计 Ta (每个街区一个值)
  │   └─ 估计线性系数 (α, β)
  └─ 输出结果
      ├─ Ta_optimized (K)
      ├─ Ta_celsius (°C)
      └─ 回归系数
```

### 数据流示意图

```
ERA5 + Landsat + DEM + LCZ (栅格)
              ↓
    [阶段1: 栅格计算]
    不需要Ta，只计算系数
              ↓
    f_Ta_coeff (栅格)
    residual (栅格)
    Ts (栅格)
              ↓
    [阶段2: 空间聚合]
    按街区多边形求平均
              ↓
    每个街区的平均系数
    (n个街区 × 3个变量)
              ↓
    [阶段3: 街区回归]
    + 街区属性 (LCZ, 人口, 建筑...)
              ↓
    ALS回归
              ↓
    每个街区一个Ta值！
    (n个街区 × 1个Ta)
```

---

## 关键假设

### 1. 晴朗无风条件

**假设**：模型适用于晴朗无风（风速 < 3-4 m/s）的条件。

**理由**：
- 有研究表明城市在有风环境——哪怕风速只有三四米每秒，热岛效应也会显著减弱
- 无风条件是抓重点，景观的影响是局地的、一阶的
- 晴朗条件确保遥感数据质量

**影响**：
- 大气稳定度固定为不稳定（unstable）
- Obukhov长度根据LCZ类型估计
- 水平热交换只影响相邻街区

### 2. 街区尺度均匀性

**假设**：每个街区内部的近地表气温Ta是一致的（不考虑阴影相关）。

**理由**：
- LCZ的局地同质性假设
- 街区是城市微气候的基本单元
- 简化计算复杂度

**影响**：
- 每个街区只有一个Ta值
- 街区内的栅格系数需要聚合
- 回归在街区尺度进行

### 3. 局地一阶影响

**假设**：景观的影响是局地的、一阶的，即其只会影响到相邻的景观单元。

**理由**：
- 无风条件下，热交换主要是局地的
- 不考虑城市规模引发的热岛效应（本身存疑）

**影响**：
- 水平热交换ΔQA只考虑相邻街区
- 回归特征可以包含相邻LCZ的影响

### 4. 能量平衡方程结构

**假设**：能量平衡方程可以分解为非线性项（依赖Ta）和线性项（不依赖Ta）。

**理由**：
- QF和ΔQSb计算与Ta独立
- ΔQA成为影响Ta的因素通过对Ta的影响体现而不成为方程单独的一项

**数学表达**：
```
f^k(Ta) + Σαi·X^k_Fi + Σβi·X^k_Si = C^k
```

其中：
- `f(Ta)`: 非线性项，依赖Ta
- `Σαi·X^k_Fi`: 线性项，人为热相关
- `Σβi·X^k_Si`: 线性项，储热相关
- `C^k`: 常数项

---

## 算法优势

### 1. 系数分解方法

**优势**：
- 栅格层面不需要知道Ta的具体值
- 只需要计算Ta的系数和常数项
- 降低了计算复杂度

**对比**：
- ❌ 错误方法：在栅格层面使用Ta栅格
- ✅ 正确方法：只计算系数，街区层面求解Ta

### 2. 街区尺度处理

**优势**：
- 符合LCZ的街区尺度概念
- 每个街区一个Ta值，物理意义明确
- 降低了回归问题的维度

### 3. ALS回归方法

**优势**：
- 同时估计Ta和线性系数
- 迭代优化，收敛稳定
- 可以处理非线性项和线性项的混合

### 4. 半物理半经验模型

**优势**：
- 物理部分（Q*, QH, QE, ΔQSg）基于SEBAL模型
- 经验部分（QF, ΔQSb, ΔQA）通过回归估计
- 平衡了物理准确性和实用性

---

## 算法局限性

### 1. 数据依赖性

- 需要高质量的遥感数据（无云条件）
- LCZ分类精度影响最终结果
- ERA5-Land数据空间分辨率较低（11km）

### 2. 假设限制

- 晴朗无风条件限制了应用范围
- 街区尺度均匀性假设可能不适用于复杂地形
- 局地一阶影响假设忽略了长距离热交换

### 3. 参数化不确定性

- 阻抗参数估算存在不确定性
- 回归系数需要大量样本验证
- 不同城市可能需要调整参数

### 4. 计算复杂度

- 大尺度区域计算耗时
- 需要大量内存存储栅格数据
- ALS迭代可能需要多次迭代才能收敛

