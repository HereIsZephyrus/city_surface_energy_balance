# 数学模型

## 目录
1. [能量平衡方程](#能量平衡方程)
2. [辐射通量计算](#辐射通量计算)
3. [热通量计算](#热通量计算)
4. [空气动力学参数](#空气动力学参数)
5. [系数分解方法](#系数分解方法)
6. [回归模型](#回归模型)

---

## 能量平衡方程

### 完整能量平衡方程

在城市及以上尺度的城市地表模型中，SEBAL及其衍生模型受到了广泛关注。本研究沿用SEBAL提出的辐射通量框架和主要的通量项计算方法。

完整的地表能量平衡方程为：

$$
Q^* + Q_{F} = Q_H + Q_E + \Delta Q_{Sb} + \Delta Q_{Sg} + \Delta Q_{A}
$$

其中：
- **Q***: 净辐射通量 (W/m²)
- **QF**: 人为热/建筑热 (W/m²) - 待估计
- **QH**: 显热通量 (W/m²)
- **QE**: 潜热通量 (W/m²)
- **ΔQSb**: 建筑储热项 (W/m²) - 待估计
- **ΔQSg**: 地热传递项 (W/m²)
- **ΔQA**: 水平交换项 (W/m²) - 待估计

### 可量化与待估计部分

**可量化部分**（依赖Ta，但可以通过物理公式计算）：
- Q*: 净辐射
- ΔQSg: 土壤热通量
- QH: 感热通量
- QE: 潜热通量

**待估计部分**（通过回归估计）：
- QF: 人为热
- ΔQSb: 建筑储热
- ΔQA: 水平热交换

### 能量平衡方程的重新组织

将能量平衡方程重新组织为：

$$
Q^*(T_a) - \Delta Q_{Sg}(T_a) - Q_H(T_a) - Q_E(T_a) = Q_F + \Delta Q_{Sb} + \Delta Q_{A}
$$

左边是可量化部分（依赖Ta），右边是待估计部分。

定义**已量化总和**：

$$
\text{Quantified}(T_a) = Q^*(T_a) - \Delta Q_{Sg}(T_a) - Q_H(T_a) - Q_E(T_a)
$$

理论上应等于待估计部分：

$$
\text{Quantified}(T_a) \approx Q_F + \Delta Q_{Sb} + \Delta Q_{A}
$$

---

## 辐射通量计算

### 净辐射 Q*

净辐射由短波和长波辐射组成：

$$
Q^* = (1 - \alpha) S \downarrow + \epsilon_0 L \downarrow - L \uparrow
$$

其中：
- **α**: 地表反照率 (0-1)
- **S↓**: 短波下行辐射 (W/m²)
- **ε₀**: 地表发射率 (0-1)
- **L↓**: 长波下行辐射 (W/m²)
- **L↑**: 长波上行辐射 (W/m²)

#### 短波下行辐射 S↓

$$
S \downarrow = G_{sc} \cdot d_r \cdot \sin \theta \cdot \tau_{sw}
$$

其中：
- **Gsc**: 太阳常数 = 1367 W/m²
- **dr**: 日地距离修正因子
- **θ**: 太阳高度角
- **τsw**: 大气透射率

**大气透射率**（高程修正）：

$$
\tau_{sw} = 0.75 + 2 \times 10^{-5} \times \text{Elevation}
$$

#### 长波下行辐射 L↓

$$
L \downarrow = \epsilon_a \sigma T_a^4
$$

其中：
- **εa**: 大气发射率
- **σ**: Stefan-Boltzmann常数 = 5.67×10⁻⁸ W/(m²·K⁴)
- **Ta**: 近地表气温 (K) - **待估计参数**

**大气发射率**：

$$
\epsilon_a = 0.85 \times (-\ln \tau_{sw})^{0.09}
$$

#### 长波上行辐射 L↑

$$
L \uparrow = \epsilon_0 \sigma T_s^4
$$

其中：
- **Ts**: 地表温度 (K) - 来自遥感反演

### 净辐射的Ta依赖关系

将净辐射展开：

$$
Q^*(T_a) = (1 - \alpha) S \downarrow + \epsilon_0 \epsilon_a \sigma T_a^4 - \epsilon_0 \sigma T_s^4
$$

对Ta求偏导数：

$$
\frac{\partial Q^*}{\partial T_a} = \epsilon_0 \cdot 4 \epsilon_a \sigma T_a^3
$$

---

## 热通量计算

### 土壤热通量 ΔQSg

对于自然表面，土壤热通量通过经验公式计算：

$$
\frac{\Delta Q_{Sg}}{Q^*} = \frac{T_s - 273.15}{\alpha} \times (0.0038 \alpha + 0.0074 \alpha^2) \times (1 - 0.98 \text{NDVI}^4)
$$

对于不透水面，近似认为：

$$
\Delta Q_{Sg} \approx 0
$$

这部分由ΔQSb贡献。

**Ta依赖关系**：

$$
\Delta Q_{Sg}(T_a) = Q^*(T_a) \times \text{ratio}(T_s, \alpha, \text{NDVI})
$$

其中ratio不依赖Ta，因此：

$$
\frac{\partial \Delta Q_{Sg}}{\partial T_a} = \text{ratio} \times \frac{\partial Q^*}{\partial T_a} = \text{ratio} \times \epsilon_0 \cdot 4 \epsilon_a \sigma T_a^3
$$

### 感热通量 QH

感热通量根据以下公式计算：

$$
Q_H = \rho C_p \frac{T_a - T_s}{r_{ah}}
$$

其中：
- **ρ**: 空气密度 (kg/m³)
- **Cp**: 空气定压比热容 = 1005.0 J/(kg·K)
- **Ta**: 近地表气温 (K) - **待估计参数**
- **Ts**: 地表温度 (K)
- **rah**: 大气湍流热交换阻抗 (s/m)

**空气密度**（依赖Ta）：

$$
\rho(T_a) = \frac{P}{R_d \times T_a}
$$

其中：
- **P**: 地表气压 (Pa) - 从ERA5-Land获取
- **Rd**: 干空气气体常数 = 287.0 J/(kg·K)

**Ta依赖关系**：

$$
Q_H(T_a) = \frac{P}{R_d T_a} \times C_p \times \frac{T_a - T_s}{r_{ah}} = \frac{P C_p}{R_d r_{ah}} \times \frac{T_a - T_s}{T_a}
$$

对Ta求偏导数（在Ta₀附近线性化）：

$$
\frac{\partial Q_H}{\partial T_a} \approx -\frac{P C_p}{R_d r_{ah} T_a^2} \times T_s + \frac{P C_p}{R_d r_{ah}} \times \frac{1}{T_a}
$$

简化形式（当Ta ≈ Ts时）：

$$
\frac{\partial Q_H}{\partial T_a} \approx -\frac{\rho C_p}{r_{ah}}
$$

### 潜热通量 QE

潜热通量根据以下公式计算：

$$
Q_E = \rho C_p \frac{e_s - e_a}{\gamma (r_{ah} + r_s)}
$$

其中：
- **es**: 饱和水汽压 (kPa) - 由地表温度Ts计算
- **ea**: 实际水汽压 (kPa) - 从ERA5-Land露点温度计算
- **γ**: 干湿计常数 = 0.067 kPa/K
- **rs**: 表面阻抗 (s/m)

**饱和水汽压**（Magnus公式）：

$$
e_s = 0.6108 \times \exp\left(\frac{17.27(T_s - 273.15)}{T_s - 35.85}\right)
$$

**实际水汽压**（从露点温度）：

$$
e_a = 0.6108 \times \exp\left(\frac{17.27(T_d - 273.15)}{T_d - 35.85}\right)
$$

其中Td是露点温度（K），从ERA5-Land获取。

**Ta依赖关系**：

$$
Q_E(T_a) = \frac{P}{R_d T_a} \times C_p \times \frac{e_s - e_a}{\gamma (r_{ah} + r_s)}
$$

对Ta求偏导数：

$$
\frac{\partial Q_E}{\partial T_a} = -\frac{P C_p (e_s - e_a)}{R_d \gamma (r_{ah} + r_s) T_a^2}
$$

---

## 空气动力学参数

### 大气湍流热交换阻抗 rah

对于非饱和表面（城市建筑区）：

$$
r_{ah} = \frac{\Phi_v}{\Phi_m} r_{am} + r_b = \frac{\Phi_v}{\Phi_m} \frac{u_z}{u_*^2} + a \cdot u_*^{-\frac{2}{3}}
$$

其中：
- **Φv, Φm**: 稳定度修正函数
- **uz**: 近地表风速 (m/s)
- **u***: 摩擦风速 (m/s)
- **a**: 经验系数 = 6.266（不透水面）

对于饱和表面（植被覆盖区）：

$$
r_{ah} = \frac{\ln(Z_{tree} - d) Z_{\rho}}{k^2 U_w}
$$

其中：
- **Ztree**: 植被平均高度 (m)
- **d**: 参考平面高度 (m)
- **Zρ**: 参考高度 (m)
- **k**: 冯·卡门常数 = 0.4
- **Uw**: 风速 (m/s)

**稳定度修正函数**（不稳定条件，晴朗白天）：

$$
\Phi_v = \Phi_m^2 = \left(1 - 16\frac{z - d}{L}\right)^{-1/2}
$$

其中：
- **z**: 参考高度 (m)
- **d**: 零平面位移高度 (m)
- **L**: Obukhov距离 (m) - 根据LCZ类型估计

### 表面阻抗 rs

表面阻抗与植被类型、LAI、土壤水分等相关。本研究使用简化的NDVI估算方法：

$$
r_s = f(\text{NDVI}, \text{LCZ类型})
$$

对于不透水面，rs很大（接近无穷大，实际计算中设为很大值）。

---

## 系数分解方法

### 能量平衡方程的线性化

将能量平衡方程在Ta₀附近线性化：

$$
f(T_a) = Q^*(T_a) - \Delta Q_{Sg}(T_a) - Q_H(T_a) - Q_E(T_a)
$$

线性化形式：

$$
f(T_a) \approx f(T_{a0}) + \frac{\partial f}{\partial T_a}\bigg|_{T_{a0}} \times (T_a - T_{a0})
$$

展开为：

$$
f(T_a) \approx \text{coeff}_{Ta} \times T_a + \text{residual}
$$

其中：

$$
\text{coeff}_{Ta} = \frac{\partial Q^*}{\partial T_a} - \frac{\partial \Delta Q_{Sg}}{\partial T_a} - \frac{\partial Q_H}{\partial T_a} - \frac{\partial Q_E}{\partial T_a}
$$

$$
\text{residual} = Q^*|_{T_{a0}} - \Delta Q_{Sg}|_{T_{a0}} - Q_H|_{T_{a0}} - Q_E|_{T_{a0}} - \text{coeff}_{Ta} \times T_{a0}
$$

### 系数计算

**Ta的系数**：

$$
\text{coeff}_{Ta} = \epsilon_0 \cdot 4 \epsilon_a \sigma T_{a0}^3 - \text{ratio} \times \epsilon_0 \cdot 4 \epsilon_a \sigma T_{a0}^3 + \frac{\rho C_p}{r_{ah}} + \frac{P C_p (e_s - e_a)}{R_d \gamma (r_{ah} + r_s) T_{a0}^2}
$$

简化形式：

$$
\text{coeff}_{Ta} \approx \epsilon_0 \cdot 4 \epsilon_a \sigma T_{a0}^3 (1 - \text{ratio}) - \frac{\rho C_p}{r_{ah}} - \frac{P C_p (e_s - e_a)}{R_d \gamma (r_{ah} + r_s) T_{a0}^2}
$$

**常数项（残差）**：

$$
\text{residual} = (1 - \alpha) S \downarrow + \epsilon_0 \epsilon_a \sigma T_{a0}^4 - \epsilon_0 \sigma T_s^4 - \Delta Q_{Sg}|_{T_{a0}} - Q_H|_{T_{a0}} - Q_E|_{T_{a0}} - \text{coeff}_{Ta} \times T_{a0}
$$

### 能量平衡方程

线性化后的能量平衡方程：

$$
\text{coeff}_{Ta} \times T_a + \text{residual} = Q_F + \Delta Q_{Sb} + \Delta Q_{A}
$$

---

## 回归模型

### 街区级回归方程

对第k个街区，能量平衡方程为：

$$
f^k(T_{a,k}) + \sum_{i=1}^n \alpha_i X^k_{F,i} + \sum_{i=1}^m \beta_i X^k_{S,i} = 0
$$

展开为：

$$
[\text{coeff}_{Ta,k}] \times T_{a,k} + [\text{residual}_k] + \sum_{i=1}^n \alpha_i X^k_{F,i} + \sum_{i=1}^m \beta_i X^k_{S,i} = 0
$$

其中：
- **coeff_{Ta,k}**: 第k个街区的Ta系数（从栅格聚合得到）
- **residual_k**: 第k个街区的残差（从栅格聚合得到）
- **X^k_{F,i}**: 第k个街区的人为热特征（如LCZ类型、不透水面面积、人口等）
- **X^k_{S,i}**: 第k个街区的储热特征（如建筑体积、植被覆盖度等）
- **αi, βi**: 待估计的回归系数

### 交替最小二乘法（ALS）

**步骤1：固定Ta，估计线性系数**

对于所有街区，构建线性回归：

$$
y_k = \sum_{i=1}^n \alpha_i X^k_{F,i} + \sum_{i=1}^m \beta_i X^k_{S,i} + \epsilon_k
$$

其中：

$$
y_k = -[\text{coeff}_{Ta,k}] \times T_{a,k} - [\text{residual}_k]
$$

使用最小二乘法求解：

$$
[\alpha, \beta] = (X^T X)^{-1} X^T y
$$

**步骤2：固定线性系数，优化Ta**

对每个街区k，求解：

$$
T_{a,k} = \frac{-[\text{residual}_k] - \sum_{i=1}^n \alpha_i X^k_{F,i} - \sum_{i=1}^m \beta_i X^k_{S,i}}{\text{coeff}_{Ta,k}}
$$

**步骤3：迭代**

重复步骤1和步骤2，直到收敛：

$$
\|T_a^{(t+1)} - T_a^{(t)}\| < \text{tol}
$$

### 空间交换项 ΔQ_A

#### 物理背景

传统的一维能量平衡模型假设每个像素/街区与大气之间的热量交换是独立的，忽略了相邻区域之间的水平热量交换（平流效应）。

对于水体等局部冷岛，纯一维模型会导致计算出的气温过低，因为：
1. 水体上方蒸发强烈，需要大量能量通过感热从大气获取
2. 一维模型中，这导致 Ta 远低于 Ts
3. 实际上，周围暖空气会水平流动到水体上方，"拉高"局地气温

#### 空间滞后模型

引入空间权重矩阵 W 来描述街区之间的邻接关系，水平交换项表示为：

$$
\Delta Q_A = \lambda \cdot (T_a - W \cdot T_a)
$$

其中：
- **W**: 空间权重矩阵（行标准化），$W_{ij}$ 表示街区 j 对街区 i 的影响权重
- **W·Ta**: 邻域平均气温，$[W \cdot T_a]_i = \sum_j W_{ij} T_{a,j}$
- **λ**: 水平交换系数（待估计），表示气温趋向邻域平均的程度

#### 含空间交换项的能量平衡方程

完整的回归方程变为：

$$
f^k(T_{a,k}) + \sum_{i=1}^n \alpha_i X^k_{F,i} + \sum_{i=1}^m \beta_i X^k_{S,i} + \lambda \cdot (T_{a,k} - [W \cdot T_a]_k) = 0
$$

#### 空间权重矩阵构建

空间权重矩阵基于街区边界之间的距离构建：

$$
W_{ij} = \begin{cases}
w(d_{ij}) & \text{if } d_{ij} < d_{threshold} \text{ and } i \neq j \\
0 & \text{otherwise}
\end{cases}
$$

支持多种距离衰减函数 w(d)：
- **binary**: $w(d) = 1$（邻居内等权重）
- **linear**: $w(d) = 1 - d/d_{threshold}$
- **inverse**: $w(d) = 1/d$
- **gaussian**: $w(d) = \exp(-d^2/2\sigma^2)$，其中 $\sigma = d_{threshold}/3$

行标准化：$W_{ij} \leftarrow W_{ij} / \sum_j W_{ij}$

#### ALS 迭代中的空间项处理

在迭代过程中：

**步骤1：计算空间滞后项**

使用当前 Ta 计算邻域平均气温：

$$
[W \cdot T_a^{(t)}]_k = \sum_j W_{kj} T_{a,j}^{(t)}
$$

**步骤2：联合回归估计系数**

将空间特征 $(T_a^{(t)} - W \cdot T_a^{(t)})$ 加入回归特征矩阵：

$$
y_k = \sum_{i=1}^n \alpha_i X^k_{F,i} + \sum_{i=1}^m \beta_i X^k_{S,i} + \lambda \cdot (T_{a,k}^{(t)} - [W \cdot T_a^{(t)}]_k) + \epsilon_k
$$

使用最小二乘法联合估计 $\alpha, \beta, \lambda$。

**步骤3：更新 Ta**

对每个街区 k，求解含空间交换项的能量方程。

对于二次方程形式（$\text{coeff}_{Ta2} \neq 0$）：

$$
\text{coeff}_{Ta2,k} \cdot T_{a,k}^2 + (\text{coeff}_{Ta1,k} + \lambda_k) \cdot T_{a,k} + (c_k - \lambda_k \cdot [W \cdot T_a^{(t)}]_k) = 0
$$

对于一次方程形式（$\text{coeff}_{Ta2} \approx 0$）：

$$
T_{a,k}^{(t+1)} = \frac{-c_k + \lambda_k \cdot [W \cdot T_a^{(t)}]_k}{\text{coeff}_{Ta1,k} + \lambda_k}
$$

其中：
- $c_k = \text{residual}_k + \sum_i \alpha_i X^k_{F,i} + \sum_i \beta_i X^k_{S,i}$
- $\lambda_k$：街区 k 的空间交换系数（覆盖范围内 $\lambda_k = \lambda$，否则 $\lambda_k = 0$）

**物理意义**：
- 当 $[W \cdot T_a]_k > T_{a,k}$（邻域更热），分子增大，使 $T_a$ 升高（热量流入）
- 当 $[W \cdot T_a]_k < T_{a,k}$（邻域更冷），分子减小，使 $T_a$ 降低（热量流出）
- $\lambda$ 越大，邻域影响越强

#### 部分覆盖模式

当空间权重矩阵只覆盖部分街区时（例如只计算了中心城区的邻接关系）：

- 只对覆盖范围内的街区应用空间交换项
- 未覆盖街区的空间特征设为 0（不参与空间交换）
- 仍然使用全部样本进行系数估计

$$
X^k_{spatial} = \begin{cases}
T_{a,k} - [W \cdot T_a]_k & \text{if } k \in \text{覆盖范围} \\
0 & \text{otherwise}
\end{cases}
$$

#### λ 的物理意义

- **λ > 0**: 气温趋向于邻域平均（热量扩散/均质化），符合物理预期
- **λ < 0**: 气温偏离邻域平均（异常，通常不应出现）
- **|λ| 大小**: 邻域影响强度，λ = 0.5 表示邻域每 1K 温差导致本街区温度变化约 0.5K

### 初始值设置

#### 方法1：ERA5 气温（默认）

直接使用 ERA5-Land 的气温作为初始值：

$$
T_{a,k}^{(0)} = T_{a,\text{ERA5},k}
$$

#### 方法2：基于地表温度的初始化（推荐）

使用地表温度 $T_s$ 初始化，并通过 ERA5 气温校正区域均值：

$$
T_{a,k}^{(0)} = T_{s,k} + (\overline{T_{a,\text{ERA5}}} - \overline{T_s})
$$

其中：
- $T_{s,k}$：第 k 个街区的平均地表温度
- $\overline{T_{a,\text{ERA5}}}$：ERA5 气温的区域平均
- $\overline{T_s}$：地表温度的区域平均

**物理意义**：
- 保留了地表温度的空间异质性（热岛、冷岛分布）
- 区域平均值与 ERA5 一致（保证宏观合理性）
- 对于空间交换项 $\lambda \cdot (T_a - W \cdot T_a)$，初始空间差异越大，空间效应越显著

### 收敛判据

- **相对误差**：$\frac{\|T_a^{(t+1)} - T_a^{(t)}\|}{\|T_a^{(t)}\|} < \text{tol}$
- **最大迭代次数**：通常设置为20次

---

## 物理常数

| 常数 | 符号 | 数值 | 单位 |
|------|------|------|------|
| Stefan-Boltzmann常数 | σ | 5.67×10⁻⁸ | W/(m²·K⁴) |
| 太阳常数 | Gsc | 1367 | W/m² |
| 空气定压比热容 | Cp | 1005.0 | J/(kg·K) |
| 干空气气体常数 | Rd | 287.0 | J/(kg·K) |
| 干湿计常数 | γ | 0.067 | kPa/K |
| 水汽化潜热 | λ | 2.5×10⁶ | J/kg |
| 冯·卡门常数 | k | 0.4 | 无量纲 |
| 标准大气压 | P0 | 101325.0 | Pa |

---

## 关键公式总结

### 1. 净辐射
$$
Q^* = (1 - \alpha) S \downarrow + \epsilon_0 \epsilon_a \sigma T_a^4 - \epsilon_0 \sigma T_s^4
$$

### 2. 感热通量
$$
Q_H = \frac{P C_p}{R_d T_a} \times \frac{T_a - T_s}{r_{ah}}
$$

### 3. 潜热通量
$$
Q_E = \frac{P C_p}{R_d T_a} \times \frac{e_s - e_a}{\gamma (r_{ah} + r_s)}
$$

### 4. 能量平衡
$$
Q^* - \Delta Q_{Sg} - Q_H - Q_E = Q_F + \Delta Q_{Sb} + \Delta Q_{A}
$$

### 5. 系数分解
$$
\text{coeff}_{Ta} \times T_a + \text{residual} = Q_F + \Delta Q_{Sb} + \Delta Q_{A}
$$

---

## 参考文献

1. Bastiaanssen, W. G. M., et al. (1998). A remote sensing surface energy balance algorithm for land (SEBAL): 1. Formulation. Journal of Hydrology, 212-213, 198-212.

2. Wallace, J. M., & Hobbs, P. V. (2006). Atmospheric Science: An Introductory Survey. Academic Press.

3. 《晴朗无风条件下城市生态空间对城市降温作用量化模型》

---

## 附录：空间效应的局限性

### 收敛特性

无论 Ta 初始值如何，ALS 迭代最终会收敛到能量平衡的唯一解。这意味着：

1. **空间交换项不会改变稳态解**：如果覆盖范围内的样本物理特性相似（如都是同类型的建成区），它们的 Ta 会收敛到相似的值，使得 $T_a - W \cdot T_a \approx 0$

2. **空间效应依赖于异质性**：空间交换项只有在覆盖范围内存在显著温差时才有效。例如：
   - 水体（冷）与周围建成区（热）的混合区域
   - 公园与商业区的交界地带

3. **部分覆盖的影响**：如果空间权重矩阵只覆盖同质区域（如只有中心城区的建成区），空间效应会很微弱

### 设计建议

要使空间交换项发挥作用：

1. **扩大覆盖范围**：确保空间权重矩阵覆盖不同类型的区域（建成区、水体、公园等）
2. **包含关注区域**：如果关注水体气温，需确保水体及其邻居都在覆盖范围内
3. **检验 λ 值**：λ ≈ 5-15 表示空间效应显著；λ ≈ 0 表示样本间温差太小

---

**最后更新**: 2025-12-02

